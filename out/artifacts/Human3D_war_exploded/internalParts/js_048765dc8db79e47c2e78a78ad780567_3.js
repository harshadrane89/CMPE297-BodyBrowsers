MappingKit.getMap=function(id){if(!id)return maps[0];for(var i=0;i<maps.length;i++)if(maps[i].div.id==id)return maps[i];return null};MappingKit.MapClient={CLASS_NAME:'MappingKit.MapClient'};
MappingKit.MapClient.OpenLayers={maps:null,registerMap:function(id,map){if(!this.maps)this.maps={};this.maps[id]=map},getMapObject:function(id){return this.maps[id]},zoomToExtent:function(id,extent){if(this.maps[id])this.maps[id].zoomToExtent(OpenLayers.Bounds.fromString(extent))},CLASS_NAME:'MappingKit.MapClient.OpenLayers'};
OpenLayers.Format.WMC.vMapContext_Parser=OpenLayers.Class(OpenLayers.Format.WMC.v1_1_0,{read_wmc_Layer:function(context,node){OpenLayers.Format.WMC.v1_1_0.prototype.read_wmc_Layer.apply(this,arguments);context.layers[context.layers.length-1].queryable=(node.getAttribute("queryable")=="1")},read_wmc_Window:function(context,node){var width=node.getAttribute('width'),height=node.getAttribute('height');if(width!=null&&height!=null)context.size=new OpenLayers.Size(parseInt(width),parseInt(height))},getLayerFromInfo:function(layerInfo){var layer=OpenLayers.Format.WMC.v1_1_0.prototype.getLayerFromInfo.apply(this,arguments);if(layerInfo.styles[0].legend)layer.legend=layerInfo.styles[0].legend;return layer},read_ol_baselayers:function(context,node){context.baselayers=this.getChildValue(node)},write_ol_MapExtension:function(context){var node=OpenLayers.Format.WMC.v1_1_0.prototype.write_ol_MapExtension.apply(this,arguments),layers=context.layers,baselayers=[];for(var i=0;i<layers.length;i++)if(layers[i].isBaseLayer){var t=layers[i].CLASS_NAME.split('.');if(t[0]=='OpenLayers'&&t[1]=='Layer')if(t.length>=3){var layer_type=t[2].toLowerCase();switch(layer_type){case'google':if(typeof layers[i].options.type.eF!='undefined')layer_type+='-'+layers[i].options.type.eF.toLowerCase();baselayers[baselayers.length]=layer_type;break;case'virtualearth':baselayers[baselayers.length]='ve';break;case'tms':baselayers[baselayers.length]='osm';break;case'yahoo':baselayers[baselayers.length]='yahoo';break;default:break}}else baselayers[baselayers.length]='none'};if(baselayers.length>0){var baselayersNode=this.createElementNS(this.namespaces.ol,'ol:baselayers');baselayersNode.appendChild(this.createTextNode(baselayers.join(',')));node.appendChild(baselayersNode)};return node},write_wmc_StyleList:function(layer){var node=OpenLayers.Format.WMC.v1_1_0.prototype.write_wmc_StyleList.apply(this,arguments);if(layer.legend&&!(layer.params['SLD']||layer.params['SLD_BODY'])){var legend=this.createElementDefaultNS("LegendURL");legend.setAttribute('format','image/png');legend.appendChild(this.write_wmc_OnlineResource(layer.legend.href));var styles=node.getElementsByTagName("Style");if(styles.length>0)styles[0].appendChild(legend)};return node},CLASS_NAME:'OpenLayers.Format.WMC.vMapContext_Parser'});OpenLayers.Format.MapContext=OpenLayers.Class(OpenLayers.Format.WMC,{initialize:function(options){OpenLayers.Format.WMC.prototype.initialize.apply(this,[options])},read:function(data,options){this.version='MapContext.Parser';return OpenLayers.Format.WMC.prototype.read.apply(this,arguments)},write:function(data,options){this.version='MapContext.Parser';return OpenLayers.Format.WMC.prototype.write.apply(this,arguments)},contextToMap:function(context,id){var map=new OpenLayers.Map(id,{maxExtent:context.maxExtent?context.maxExtent:context.bounds,projection:context.projection});this.mergeContextToMap(context,map);map.setCenter(context.bounds.getCenterLonLat(),map.getZoomForExtent(context.bounds,true));return map},mergeContextToMap:function(context,map){if(context.baselayers){var baselayers=context.baselayers.split(','),layers=[],common_options={isBaseLayer:true};if(map.projection.projCode=='EPSG:900913')common_options.sphericalMercator=true;for(var i=0;i<baselayers.length;i++){var layer={options:{}},baselayer_def=baselayers[i].split('|'),baselayer=baselayer_def[0].split('-');for(var j=1;j<baselayer_def.length;j++){var kv=baselayer_def[j].split('=');if(kv.length==2){key=kv[0];value=kv[1];layer.options[key]=(value=='true'?true:(value=='false'?false:(isNaN(new Number(value))?value:parseFloat(value))))}};switch(baselayer[0]){case'none':layer.vendor='none';break;case'google':if(typeof G_HYBRID_MAP=='undefined')continue;layer.vendor='google';var type=G_HYBRID_MAP,variant='default';if(baselayer.length>1)switch(variant=baselayer[1]){case'hybrid':break;case'streets':type=G_NORMAL_MAP;break;case'satellite':type=G_SATELLITE_MAP;break;case'terrain':case'physical':type=G_PHYSICAL_MAP;break};layer.title='Google - '+variant;layer.options.type=type;break;case'oam':layer.vendor='oam';layer.options.type='png';layer.options.getURL=osm_getTileURL;layer.options.displayOutsideMaxExtent=true;layer.title='OpenAerialMap';layer.options.attribution='<a href="http://www.openaerialmap.org/">OpenAerialMap</a>';common_options.sphericalMercator=true;break;case'osm':layer.vendor='osm';layer.options.type='png';layer.options.getURL=osm_getTileURL;layer.options.displayOutsideMaxExtent=true;layer.title='OpenStreetMap';layer.options.attribution='<a href="http://www.openstreetmap.org/">OpenStreetMap</a>';common_options.sphericalMercator=true;break;case've':layer.vendor='ve';if(typeof VEMapStyle=='undefined')continue;var type=VEMapStyle.Hybrid,variant='default';layer.title='Virtual Earth - '+variant;layer.options.type=type;break;case'yahoo':layer.vendor='yahoo';if(typeof YAHOO_MAP_HYB=='undefined')continue;var type=YAHOO_MAP_HYB,variant='default';layer.title='Yahoo - '+variant;layer.options.type=type;break;default:alert(Drupal.t('Unknown layer type: '+baselayer[0]));continue};layers[layers.length]=layer};for(var i=0;i<layers.length;i++){var layer=layers[i];OpenLayers.Util.extend(layer.options,common_options);switch(layer.vendor){case'google':map.addLayers([new OpenLayers.Layer.Google(layer.title,layer.options)]);break;case'none':map.addLayers([new OpenLayers.Layer(Drupal.t('None'),layer.options)]);break;case'oam':map.addLayers([new OpenLayers.Layer.TMS(layer.title,'http://tile.openaerialmap.org/tiles/1.0.0/openaerialmap-900913/',layer.options)]);break;case'osm':map.addLayers([new OpenLayers.Layer.TMS(layer.title,'http://tile.openstreetmap.org/',layer.options)]);break;case've':map.addLayers([new OpenLayers.Layer.VirtualEarth(layer.title,layer.options)]);break;case'yahoo':map.addLayers([new OpenLayers.Layer.Yahoo(layer.title,layer.options)]);break}}};if(!map.baseLayer&&context.layers.length>0)context.layers[0].isBaseLayer=true;if(context.projection!=map.getProjection()){map.projection=new OpenLayers.Projection(context.projection);map.units='m';map.maxExtent=context.maxExtent?context.maxExtent:context.bounds;var size=context.size?context.size:map.size;map.maxResolution=map.maxExtent.getWidth()/size.w;var maxResY=map.maxExtent.getHeight()/size.h;if(maxResY>map.maxResolution)map.maxResolution=maxResY};if(context.maxExtent)map.maxExtent.extend(context.maxExtent);map.addLayers(context.layers);if(!map.title)map.title=context.title;return map},mapToContext:function(map){var context=OpenLayers.Format.WMC.prototype.mapToContext.apply(this,arguments);context.title=map.title;if(map.displayProjection){context.projection=map.displayProjection;context.bounds.transform(map.projection,map.displayProjection);context.maxExtent.transform(map.projection,map.displayProjection)};return context},CLASS_NAME:"OpenLayers.Format.MapContext"});
OpenLayers.Format.OWSContext=OpenLayers.Class({defaultVersion:"0.3.1",version:null,layerOptions:{},layerParams:{},groupByService:false,parser:null,initialize:function(options){OpenLayers.Util.extend(this,options);this.options=options},read:function(data,options){if(typeof data=="string")data=OpenLayers.Format.XML.prototype.read.apply(this,[data]);var root=data.documentElement,version=this.version;if(!version){version=root.getAttribute("version");if(!version)version=this.defaultVersion};if(!this.parser||this.parser.VERSION!=version){var format=OpenLayers.Format.OWSContext["v"+version.replace(/\./g,"_")];if(!format)throw"Can't find a OWSContext parser for version "+version;this.parser=new format(this.options)};var context=this.parser.read(data,options),map;if(options&&options.map){this.context=context;if(options.map instanceof OpenLayers.Map){map=this.mergeContextToMap(context,options.map)}else map=this.contextToMap(context,options.map)}else map=context;return map},contextToMap:function(context,id){var map=new OpenLayers.Map(id,{allOverlays:true,maxExtent:context.maxExtent,projection:context.projection});map.addLayers(context.layers);map.setCenter(context.bounds.getCenterLonLat(),map.getZoomForExtent(context.bounds,true));return map},mergeContextToMap:function(context,map){if(context.baselayers){var baselayers=context.baselayers.split(','),layers=[];for(var i=0;i<baselayers.length;i++){var options={isBaseLayer:true,sphericalMercator:true};switch(baselayers[i]){case'google':if(typeof G_HYBRID_MAP!='undefined'){options.type=G_HYBRID_MAP;layers.push(new OpenLayers.Google('Google',options))};break;case'none':layers.push(new OpenLayers.Layer(Drupal.t('None'),options));break;case'osm':options.type='png';options.getURL=osm_getTileURL;options.displayOutsideMaxExtent=true;layers.push(new OpenLayers.Layer.TMS('OpenStreetMap','http://tile.openstreetmap.org/',options));break;case've':case'bing':if(typeof VEMapStyle!='undefined'){options.type=VEMapStyle.Hybrid;layers.push(new OpenLayers.Layer.VirtualEarth('Bing',options))};break};if(layers.length>0){var options={sphericalMercator:true,units:'m'};options.projection=new OpenLayers.Projection('EPSG:900913');options.displayProjection=new OpenLayers.Projection('EPSG:4326');options.maxExtent=new OpenLayers.Bounds(-20037508.34,-20037508.34,20037508.34,20037508.34);options.maxResolution=2*20037508.34/256;map.setOptions(options);map.addLayers(layers)}}};if(!map.baseLayer&&context.layers.length>0)context.layers[0].isBaseLayer=true;if(context.maxExtent)map.maxExtent.extend(context.maxExtent);map.addLayers(context.layers);if(!map.title)map.title=context.title;return map},write:function(obj,options){if(obj.CLASS_NAME=="OpenLayers.Map")obj=this.mapToContext(obj);var version=(options&&options.version)||this.version||this.defaultVersion;if(!this.parser||this.parser.VERSION!=version){var format=OpenLayers.Format.OWSContext["v"+version.replace(/\./g,"_")];if(!format)throw"Can't find a OWSContext capabilities parser for version "+version;this.parser=new format(this.options)};var wmc=this.parser.write(obj,options);return wmc},mapToContext:function(map){var context={bounds:map.getExtent(),maxExtent:map.maxExtent,projection:map.projection,layers:map.layers,title:map.title?map.title:'OpenLayers OWSContext',size:map.getSize()};return context},CLASS_NAME:"OpenLayers.Format.OWSContext"});
OpenLayers.Format.OWSContext.v0_3_1=OpenLayers.Class(OpenLayers.Format.XML,{namespaces:{owc:"http://www.opengis.net/ows-context",gml:"http://www.opengis.net/gml",kml:"http://www.opengis.net/kml/2.2",ogc:"http://www.opengis.net/ogc",ol:"http://openlayers.org/context",ows:"http://www.opengis.net/ows",sld:"http://www.opengis.net/sld",xlink:"http://www.w3.org/1999/xlink",xsi:"http://www.w3.org/2001/XMLSchema-instance"},VERSION:"0.3.1",schemaLocation:"http://www.opengis.net/ows-context http://www.ogcnetwork.net/schemas/owc/0.3.1/owsContext.xsd",defaultPrefix:"owc",extractAttributes:true,xy:true,kmlFormat:new OpenLayers.Format.KML({extractStyles:true}),gmlFormat:new OpenLayers.Format.GML(),regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},featureNS:"http://mapserver.gis.umn.edu/mapserver",geometryTypes:OpenLayers.Format.GML.v2.prototype.geometryTypes,featureType:'vector',geometryName:'geometry',initialize:function(options){OpenLayers.Format.XML.prototype.initialize.apply(this,[options])},getOptions:function(options,className){if(this.layerOptions[className])OpenLayers.Util.applyDefaults(options,this.layerOptions[className]);return options},getLayerFromInfo:function(layerInfo){if(layerInfo.minScaleDenominator)layerInfo.options.maxScale=layerInfo.minScaleDenominator;if(layerInfo.maxScaleDenominator)layerInfo.options.minScale=layerInfo.maxScaleDenominator;if(layerInfo.nestingPath)layerInfo.options.nestingPath=layerInfo.nestingPath;var params,layer;if(layerInfo.features){layer=new OpenLayers.Layer.Vector(layerInfo.title,this.getOptions(layerInfo.options,'OpenLayers.Layer.Vector'));layer.addFeatures(layerInfo.features)}else if(layerInfo.service)switch(layerInfo.service){case"urn:ogc:serviceType:WMS":params=this.layerParams['OpenLayers.Layer.WMS']||{};params.LAYERS=layerInfo.name;params.FORMAT=layerInfo.format;params.VERSION=layerInfo.version;layer=new OpenLayers.Layer.WMS(layerInfo.title,layerInfo.href,params,this.getOptions(layerInfo.options,'OpenLayers.Layer.WMS'));break;case"urn:ogc:serviceType:WFS":layerInfo.options.strategies=[new OpenLayers.Strategy.BBOX()];layerInfo.options.protocol=new OpenLayers.Protocol.WFS({url:layerInfo.href,featurePrefix:layerInfo.name.split(":")[0],featureType:layerInfo.name.split(":").pop()});layer=new OpenLayers.Layer.Vector(layerInfo.title,this.getOptions(layerInfo.options,'OpenLayers.Layer.Vector'));break;case"urn:ogc:serviceType:GML":layerInfo.options.strategies=[new OpenLayers.Strategy.Fixed()];layerInfo.options.protocol=new OpenLayers.Protocol.HTTP({url:layerInfo.href,format:this.gmlFormat});layer=new OpenLayers.Layer.Vector(layerInfo.title,this.getOptions(layerInfo.options,'OpenLayers.Layer.Vector'));break;case"urn:ogc:serviceType:KML":layerInfo.options.strategies=[new OpenLayers.Strategy.Fixed()];layerInfo.options.protocol=new OpenLayers.Protocol.HTTP({url:layerInfo.href,format:this.kmlFormat});layer=new OpenLayers.Layer.Vector(layerInfo.title,this.getOptions(layerInfo.options,'OpenLayers.Layer.Vector'));break;default:layer=null;break};return layer},setNestingPath:function(l){if(l.layerInfo)for(var i=0,max=l.layerInfo.length;i<max;i++){var layerInfo=l.layerInfo[i],nPath="",nTitle="";if(l.nestingPath)nPath=l.nestingPath;if(l.title&&!l.href&&!l.features)nTitle=l.title;if(nPath!=""){nPath=nPath+"/"+nTitle}else nPath=nTitle;layerInfo.nestingPath=nPath;if(layerInfo.layerInfo)this.setNestingPath(layerInfo)}},read:function(data){if(typeof data=="string")data=OpenLayers.Format.XML.prototype.read.apply(this,[data]);if(data&&data.nodeType==9)data=data.documentElement;var context={};context.layers=[];this.readNode(data,context);this.setNestingPath({layerInfo:context.layerInfo});this.processLayer(context.layers,context);return context},findLayer:function(layerArray,url){for(var i=0,len=layerArray.length;i<len;i++){var layer=layerArray[i];if(layer instanceof OpenLayers.Layer.WMS&&layer.url===url)return layer};return false},processLayer:function(layerArray,layer){if(layer.layerInfo)for(var i=0,len=layer.layerInfo.length;i<len;i++){var l=layer.layerInfo[i],layerObj=this.getLayerFromInfo(l);if(layerObj!=null){var lyr=false;if(this.groupByService)lyr=this.findLayer(layerArray,layerObj.url);if(lyr!==false){lyr.params.LAYERS+=","+layerObj.params.LAYERS}else layerArray.push(layerObj)};if(l.layerInfo)this.processLayer(layerArray,l)}},write:function(context,options){var name="OWSContext",root=this.writeNode(name,context);this.setAttributeNS(root,this.namespaces["xsi"],"xsi:schemaLocation",this.schemaLocation);return OpenLayers.Format.XML.prototype.write.apply(this,[root])},readers:{kml:{Document:function(node,obj){obj.features=this.kmlFormat.read(node)}},owc:{OWSContext:function(node,obj){this.readChildNodes(node,obj)},General:function(node,obj){this.readChildNodes(node,obj)},ResourceList:function(node,obj){this.readChildNodes(node,obj)},Layer:function(node,obj){var layerInfo={options:{visibility:(node.getAttribute("hidden")!="1"),queryable:(node.getAttribute("queryable")=="1")}};if(node.getAttribute("name")!==null)layerInfo.name=node.getAttribute("name");if(!obj.layerInfo)obj.layerInfo=[];obj.layerInfo.push(layerInfo);this.readChildNodes(node,layerInfo)},InlineGeometry:function(node,obj){obj.features=[];var elements=this.getElementsByTagNameNS(node,this.namespaces.gml,"featureMember"),el;if(elements.length>=1)el=elements[0];if(el&&el.firstChild){var featurenode=(el.firstChild.nextSibling)?el.firstChild.nextSibling:el.firstChild;this.setNamespace("feature",featurenode.namespaceURI);this.featureType=featurenode.localName||featurenode.nodeName.split(":").pop();this.readChildNodes(node,obj)}},Server:function(node,obj){if((!obj.service&&!obj.version)||(obj.service!='urn:ogc:serviceType:WMS')){obj.service=node.getAttribute("service");obj.version=node.getAttribute("version");this.readChildNodes(node,obj)}},Name:function(node,obj){obj.name=this.getChildValue(node);this.readChildNodes(node,obj)},Title:function(node,obj){obj.title=this.getChildValue(node);this.readChildNodes(node,obj)},StyleList:function(node,obj){obj.options.styles=[];this.readChildNodes(node,obj.options.styles)},Style:function(node,obj){var style={};obj.push(style);this.readChildNodes(node,style)},LegendURL:function(node,obj){var legend={};obj.legend=legend;this.readChildNodes(node,legend)},OnlineResource:function(node,obj){obj.href=this.getAttributeNS(node,this.namespaces.xlink,"href");this.readChildNodes(node,obj)},Window:function(node,obj){obj.size=new OpenLayers.Size(node.getAttribute('width'),node.getAttribute('height'))},Extension:function(node,obj){this.readChildNodes(node,obj)}},ol:{baselayers:function(node,obj){obj.baselayers=this.getChildValue(node);if(obj.baselayers.indexOf('google')>=0||obj.baselayers.indexOf('osm')>=0||obj.baselayers.indexOf('bing')>=0||obj.baselayers.indexOf('ve')>=0){if(!this.options.layerOptions['OpenLayers.Layer.Vector'])this.options.layerOptions['OpenLayers.Layer.Vector']={};this.options.layerOptions['OpenLayers.Layer.Vector'].projection=new OpenLayers.Projection('EPSG:4326')}}},ows:{OutputFormat:function(node,obj){obj.format=this.getChildValue(node);this.readChildNodes(node,obj)},BoundingBox:function(node,obj){obj.projection=node.getAttribute("crs");this.readChildNodes(node,obj)},LowerCorner:function(node,obj){var str=this.getChildValue(node).replace(this.regExes.trimSpace,"");str=str.replace(this.regExes.trimComma,",");var pointList=str.split(this.regExes.splitSpace);obj.left=pointList[0];obj.bottom=pointList[1]},UpperCorner:function(node,obj){var str=this.getChildValue(node).replace(this.regExes.trimSpace,"");str=str.replace(this.regExes.trimComma,",");var pointList=str.split(this.regExes.splitSpace);obj.right=pointList[0];obj.top=pointList[1];obj.bounds=new OpenLayers.Bounds(obj.left,obj.bottom,obj.right,obj.top)},Title:function(node,obj){obj.title=this.getChildValue(node)}},gml:OpenLayers.Format.GML.v2.prototype.readers.gml,sld:OpenLayers.Format.SLD.v1_0_0.prototype.readers.sld,feature:OpenLayers.Format.GML.v2.prototype.readers.feature},writeLayerScaleInfo:function(layerOptions,node){if(layerOptions.maxScale)this.writeNode("sld:MinScaleDenominator",layerOptions.maxScale,node);if(layerOptions.minScale)this.writeNode("sld:MaxScaleDenominator",layerOptions.minScale,node)},writers:{owc:{OWSContext:function(options){var node=this.createElementNSPlus("OWSContext",{attributes:{version:this.VERSION,id:OpenLayers.Util.createUniqueID("OpenLayers_OWSContext_")}});this.writeNode("General",options,node);this.writeNode("ResourceList",options,node);return node},General:function(options){var node=this.createElementNSPlus("General");this.writeNode("ows:BoundingBox",options,node);this.writeNode("ows:Title",options.title,node);return node},ResourceList:function(options){var node=this.createElementNSPlus("ResourceList");this.resourceList=node;for(var i=0,len=options.layers.length;i<len;i++){var layer=options.layers[i];if(layer instanceof OpenLayers.Layer.WMS){this.writeNode("_WMS",layer,node)}else if(layer instanceof OpenLayers.Layer.Vector)if(layer.protocol instanceof OpenLayers.Protocol.WFS.v1){this.writeNode("_WFS",layer,node)}else if(layer.protocol instanceof OpenLayers.Protocol.HTTP){if(layer.protocol.format instanceof OpenLayers.Format.GML){layer.protocol.format.version="2.1.2";this.writeNode("_GML",layer,node)}else if(layer.protocol.format instanceof OpenLayers.Format.KML){layer.protocol.format.version="2.2";this.writeNode("_KML",layer,node)}}else{this.setNamespace("feature",this.featureNS);this.writeNode("_InlineGeometry",layer,node)}};return node},Server:function(options){var node=this.createElementNSPlus("Server",{attributes:{version:options.version,service:options.service}});this.writeNode("OnlineResource",options,node);return node},OnlineResource:function(options){var node=this.createElementNSPlus("OnlineResource",{attributes:{"xlink:href":options.href}});return node},InlineGeometry:function(layer){var node=this.createElementNSPlus("InlineGeometry");this.writeNode("gml:boundedBy",layer.getDataExtent(),node);for(var i=0,len=layer.features.length;i<len;i++)this.writeNode("gml:featureMember",layer.features[i],node);return node},StyleList:function(styles){var node=this.createElementNSPlus("StyleList");for(var i=0,len=styles.length;i<len;i++)this.writeNode("Style",styles[i],node);return node},Style:function(style){var node=this.createElementNSPlus("Style");this.writeNode("Name",style,node);this.writeNode("Title",style,node);this.writeNode("LegendURL",style,node);return node},Name:function(obj){var node=this.createElementNSPlus("Name",{value:obj.name});return node},Title:function(obj){var node=this.createElementNSPlus("Title",{value:obj.title});return node},LegendURL:function(style){var node=this.createElementNSPlus("LegendURL");this.writeNode("OnlineResource",style.legend,node);return node},__WMS:function(layer){var node=this.createElementNSPlus("Layer",{attributes:{name:layer.params.LAYERS,queryable:layer.queryable?"1":"0",hidden:layer.visibility?"0":"1"}});this.writeNode("ows:Title",layer.name,node);this.writeNode("ows:OutputFormat",layer.params.FORMAT,node);this.writeNode("Server",{service:'urn:ogc:serviceType:WMS',version:layer.params.VERSION,href:layer.url},node);if(layer.styles&&layer.styles.length>0)this.writeNode("StyleList",layer.styles,node);this.writeLayerScaleInfo(layer.options,node);return node},_WMS:function(layer){if(layer.nestingPath){var title;if(layer.nestingPath.indexOf("/")>=0){title=layer.nestingPath.substring(0,layer.nestingPath.indexOf("/"));layer.nestingPath=layer.nestingPath.substring(layer.nestingPath.indexOf("/")+1,layer.nestingPath.length)}else{title=layer.nestingPath;delete layer.nestingPath};var node=null;if(title!==layer.previousTitle){var layers=this.getElementsByTagNameNS(this.resourceList,this.namespaces[this.defaultPrefix],"Layer");for(var i=0,len=layers.length;i<len;i++){var l=layers[i],titles=this.getElementsByTagNameNS(l,this.namespaces.ows,"Title");if(titles&&titles.length>0&&titles[0].firstChild.nodeValue===title){node=l;break}}};if(node===null){node=this.createElementNSPlus("Layer");this.writeNode("ows:Title",title,node)};layer.previousTitle=title;this.writeNode("_WMS",layer,node);return node}else return this.writeNode("__WMS",layer)},_WFS:function(layer){var node=this.createElementNSPlus("Layer",{attributes:{name:layer.protocol.featureType,hidden:layer.visibility?"0":"1"}});this.writeNode("ows:Title",layer.name,node);this.writeNode("Server",{service:'urn:ogc:serviceType:WFS',version:layer.protocol.version,href:layer.protocol.url},node);this.writeLayerScaleInfo(layer.options,node);return node},_InlineGeometry:function(layer){var node=this.createElementNSPlus("Layer",{attributes:{name:this.featureType,hidden:layer.visibility?"0":"1"}});this.writeNode("ows:Title",layer.name,node);this.writeNode("InlineGeometry",layer,node);return node},_GML:function(layer){var node=this.createElementNSPlus("Layer");this.writeNode("ows:Title",layer.name,node);this.writeNode("Server",{service:'urn:ogc:serviceType:GML',href:layer.protocol.url,version:layer.protocol.format.version},node);this.writeLayerScaleInfo(layer.options,node);return node},_KML:function(layer){var node=this.createElementNSPlus("Layer");this.writeNode("ows:Title",layer.name,node);this.writeNode("Server",{service:'urn:ogc:serviceType:KML',version:layer.protocol.format.version,href:layer.protocol.url},node);this.writeLayerScaleInfo(layer.options,node);return node}},ows:{BoundingBox:function(options){var node=this.createElementNSPlus("ows:BoundingBox",{attributes:{crs:options.projection}});this.writeNode("ows:LowerCorner",options,node);this.writeNode("ows:UpperCorner",options,node);return node},LowerCorner:function(options){var node=this.createElementNSPlus("ows:LowerCorner",{value:options.bounds.left+" "+options.bounds.bottom});return node},UpperCorner:function(options){var node=this.createElementNSPlus("ows:UpperCorner",{value:options.bounds.right+" "+options.bounds.top});return node},Title:function(title){var node=this.createElementNSPlus("ows:Title",{value:title});return node},OutputFormat:function(format){var node=this.createElementNSPlus("ows:OutputFormat",{value:format});return node}},gml:OpenLayers.Util.applyDefaults({boundedBy:function(bounds){var node=this.createElementNSPlus("gml:boundedBy");this.writeNode("gml:Box",bounds,node);return node}},OpenLayers.Format.GML.v2.prototype.writers.gml),sld:OpenLayers.Format.SLD.v1_0_0.prototype.writers.sld,feature:OpenLayers.Format.GML.v2.prototype.writers.feature},CLASS_NAME:"OpenLayers.Format.OWSContext.v0_3_1"});
MappingKit.Control.MapContext=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){if(this.map){var wmc_options={layerOptions:{buffer:0}},wmc=new OpenLayers.Format.MapContext(wmc_options),uri='';if(!this.map.title)this.map.title=Drupal.t('Unknown');try{var text=wmc.write(this.map,{});if(!MappingKit.settings.fileDirectoryTemp){alert(Drupal.t('The temporary directory of this site is not accessible.'))}else{uri=Drupal.settings.basePath+MappingKit.settings.basePath+'/serializer.php?file_directory_temp='+MappingKit.settings.fileDirectoryTemp+'&base_path='+Drupal.settings.basePath;if(MappingKit.settings.fileMode)uri+='&file_mode='+MappingKit.settings.fileMode;jQuery.post(uri,{postBody:text},function(response){data=Drupal.parseJson(response);window.open(data.fileUrl,'WMC')})}}catch(err){alert('wmc error: '+err.message+'\nuri: '+uri)}}},CLASS_NAME:"mk.Control.MapContext"});
MappingKit.Legend=OpenLayers.Class({div:null,map:null,initialize:function(map,div,options){OpenLayers.Util.extend(this,options);this.div=OpenLayers.Util.getElement(div);if(!(map instanceof OpenLayers.Map))map=MappingKit.getMap(map);this.setMap(map)},setMap:function(map){this.map=map;this.map.events.on({addlayer:this.redraw,changelayer:this.redraw,removelayer:this.redraw,changebaselayer:this.redraw,scope:this})},redraw:function(){if(!this.div)return;var layers=this.map.layers;for(var i=0;i<layers.length;i++){var layer=layers[i],known_layer=false;if(layer.displayInLegend&&layer.visibility&&layer.legend){$('p',this.div).each(function(index,domEle){if($(domEle).text()==layer.name){$(domEle).parent().addClass('show-legend');known_layer=true;return}});if(!known_layer){var layerElem=document.createElement('div');layerElem.className='show-legend';var titleElem=document.createElement('p');titleElem.innerHTML=layer.name;titleElem.className='legend-title';layerElem.appendChild(titleElem);var imgElem=document.createElement('img');imgElem.src=layer.legend.href;imgElem.title=layer.name;layerElem.appendChild(imgElem);this.div.appendChild(layerElem)}}};$('div:not(.show-legend)',this.div).hide();$('div.show-legend',this.div).show().removeClass('show-legend');return this.div},CLASS_NAME:"MappingKit.Legend"});
OpenLayers.Control.Ruler=OpenLayers.Class(OpenLayers.Control,{outputDiv:null,rulerStyleMap:null,measureControls:null,initialize:function(options){options.type=OpenLayers.Control.TYPE_TOOL;this.outputDiv=document.getElementById(options.div);OpenLayers.Control.prototype.initialize.apply(this,[options])},setMap:function(map){OpenLayers.Control.prototype.setMap.apply(this,arguments);var sketchSymbolizers={Point:{pointRadius:4,graphicName:"square",fillColor:"white",fillOpacity:1,strokeWidth:1,strokeOpacity:1,strokeColor:"#333333"},Line:{strokeWidth:3,strokeOpacity:1,strokeColor:"#666666",strokeDashstyle:"dash"},Polygon:{strokeWidth:2,strokeOpacity:1,strokeColor:"#666666",fillColor:"white",fillOpacity:0.3}},style=new OpenLayers.Style();style.addRules([new OpenLayers.Rule({symbolizer:sketchSymbolizers})]);var styleMap=new OpenLayers.StyleMap({"default":style});this.measureControls={line:new OpenLayers.Control.Measure(OpenLayers.Handler.Path,{persist:true,handlerOptions:{layerOptions:{styleMap:styleMap}}})};this.measureControls.line.events.register('measure',this,this.handleMeasurements);this.measureControls.line.events.register('measurepartial',this,this.handleMeasurements);this.map.addControl(this.measureControls.line)},activate:function(){alert('activate');this.measureControls.line.activate();return OpenLayers.Control.prototype.activate.apply(this)},deactivate:function(){alert('deactivate');this.measureControls.line.deactivate();this.outputDiv.innerHTML='';return OpenLayers.Control.prototype.deactivate.apply(this)},draw:function(){OpenLayers.Control.prototype.draw.apply(this,arguments)},redraw:function(evt){var dist=this.getDistance();if(dist)this.outputDiv.innerHTML=Drupal.t('Distance: ')+dist},handleMeasurements:function(event){var geometry=event.geometry,units=event.units,order=event.order,measure=event.measure,out='';if(order==1){out+=Drupal.t('measure: ')+measure.toFixed(3)+" "+units}else out+=Drupal.t('measure: ')+measure.toFixed(3)+" "+units+"<sup>2</sup>";this.outputDiv.innerHTML=out},round_sig:function(val,sig){if(val==0)return 0;var sign=val>0?1:-1;val=Math.abs(val);var exp=Math.floor(Math.log(val)/Math.LN10+1),powers=[1,10,100,1e3,1e4,1e5,1e6,1e7,1e8,1e9,1e10],pow10sig=powers[sig],pow10exp=powers[exp],significand=val/pow10exp;val=Math.round(significand*pow10sig)*pow10exp/pow10sig;return sign*val},CLASS_NAME:"OpenLayers.Control.Ruler"});
MappingKit.Control.PrintContext=OpenLayers.Class(OpenLayers.Control,{type:OpenLayers.Control.TYPE_BUTTON,trigger:function(){if(this.map){var wmc_options={layerOptions:{buffer:0}},wmc=new OpenLayers.Format.MapContext(wmc_options),uri='';if(!this.map.title)this.map.title=Drupal.t('No title');try{var text=wmc.write(this.map,{});uri=Drupal.settings.basePath+'?q=map2pdf';jQuery.ajax({type:'POST',url:uri,data:{postBody:text},success:function(response){data=Drupal.parseJson(response);if(data.fileUrl){window.open(data.fileUrl,'PDF')}else alert(data.data)},error:function(xmlhttp,textStatus,errorThrown){alert(xmlhttp.statusText)}})}catch(err){alert('wmc error: '+err.message+'\nuri: '+uri)}}},CLASS_NAME:"mk.Control.PrintContext"});
MappingKit.Control.FeatureInfo=OpenLayers.Class(OpenLayers.Control,{initialize:function(options){options.type=OpenLayers.Control.TYPE_TOOL;OpenLayers.Control.prototype.initialize.apply(this,[options])},activate:function(){alert('activate');if(this.map)this.map.events.register('click',this.map,this.request_info);return OpenLayers.Control.prototype.activate.apply(this)},deactivate:function(){if(this.map)this.map.events.unregister('click',this.map,this.request_info);$("#featureinfo").empty();return OpenLayers.Control.prototype.deactivate.apply(this)},request_info:function(e){$("#featureinfo").empty();var count=0;MappingKit.FeatureInfo={};for(var i=0;i<this.layers.length;i++){var layer=this.layers[i];if(layer instanceof OpenLayers.Layer.WMS&&layer.visibility&&layer.queryable){var requestOptions={REQUEST:"GetFeatureInfo",EXCEPTIONS:"application/vnd.ogc.se_xml",BBOX:this.getExtent().toBBOX(),X:e.xy.x,Y:e.xy.y,QUERY_LAYERS:layer.params.LAYERS,WIDTH:this.size.w,HEIGHT:this.size.h};if(layer.info_formats&&layer.info_formats.length>0){requestOptions.INFO_FORMAT=layer.info_formats[0]}else requestOptions.INFO_FORMAT='text/plain';var url=layer.getFullRequestString(requestOptions);url=OpenLayers.ProxyHost+escape(url);MappingKit.FeatureInfo[layer.id]={requestOptions:requestOptions,layer:layer};var xhr=jQuery.ajax({type:'GET',url:url,complete:MappingKit.complete,data:{featureinfo_id:layer.id},dataType:'html'});count+=1}};OpenLayers.Event.stop(e);if(count==0)OpenLayers.Console.info(Drupal.t('No queryable layers'))},CLASS_NAME:'mk.Control.FeatureInfo'});MappingKit.complete=function(xhr,textStatus){var params={},parts=this.url.split('?');params.service=parts[0];var list=parts[1].split('&');for(var i=0;i<list.length;i++){var tmp=list[i].split('=');params[tmp[0]]=tmp[1]};var info=MappingKit.FeatureInfo[params.featureinfo_id],str=textStatus;if(xhr.status==200){var text=xhr.responseText;switch(info.requestOptions.INFO_FORMAT){case'text/html':if(text.search(/<body>\s*<\/body>/i)>=0)return;break;default:if(text=='GetFeatureInfo results:\n\n  Search returned no results.\n')return;break};var output='<div class="featureinfo title">'+info.layer.name+'</div>',html='';switch(info.requestOptions.INFO_FORMAT){case'text/html':break;default:var layers=text.match(/Layer \'(.*)\'((\s+Feature (.*)\:)*(\s+(.*) = \'(.*)\')*)*/g);for(var i=0;i<layers.length;i++){var match=layers[i].match(/Layer \'(.*)\'/),layer_name=match[1],features=layers[i].match(/Feature (.*)\:(\s+(.*) = \'(.*)\')*/g);for(var k=0;k<features.length;k++){html+='<p>';var match=features[k].match(/Feature (.*)\:/),feature_id=match[1];html+='<h4>'+Drupal.t('Feature %id',{'%id':match[1]})+'</h4>';var attrs=features[k].match(/\s+(.*) = \'(.*)\'/g);for(var n=0;n<attrs.length;n++){var match=attrs[n].match(/\s+(.*) = \'(.*)\'/);html+=MappingKit.translateAttribute(match[1],layer_name)+' = '+match[2]+'<br/>'};html+='</p>'};html+='<br/>'}};output+=html;$("#featureinfo").append(output)}else alert(Drupal.t('Error: @text (@code)',{'@text':xhr.statusText,'@code':xhr.status}))};
MappingKit.Control.LayerSwitcher=OpenLayers.Class(OpenLayers.Control.LayerSwitcher,{initialize:function(options){OpenLayers.Control.LayerSwitcher.prototype.initialize.apply(this,arguments)},loadContents:function(){OpenLayers.Control.LayerSwitcher.prototype.loadContents.apply(this,arguments);this.div.style.top='25px';this.layersDiv.style.width='195px';this.layersDiv.style.paddingLeft='5px';this.layersDiv.style.paddingRight='0px';this.layersDiv.style.overflowX='hidden';this.layersDiv.style.maxHeight=(this.map.size.h-50)+'px';this.layersDiv.style.overflowY='auto'},CLASS_NAME:'mk.Control.LayerSwitcher'});